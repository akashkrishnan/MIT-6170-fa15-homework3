<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title><%= web.name %></title>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" type="text/css" href="/styles/global.css">
    <link rel="stylesheet" type="text/css" href="/styles/layout.css">
    <link rel="stylesheet" type="text/css" href="/styles/shadow.css">
    <link rel="stylesheet" type="text/css" href="/styles/feed.css">
    <link rel="stylesheet" type="text/css" href="/styles/home.css">
  </head>

  <body fullbleed fit>

    <div masthead layout-horizontal layout-center shadow elevation="1">

      <div name><strong><%= web.name %></strong></div>

      <div home>
        <div>Home</div>
      </div>

      <div flex></div>

      <input id="search" placeholder="Enter username to view profile..."/>

      <div logout>
        <div>Logout</div>
      </div>

    </div>

    <div content>
      <div layout-horizontal layout-center-justified>
        <div layout-vertical>

          <div compose-tweet layout-vertical shadow elevation="1">
            <textarea tweet-input rows="1" placeholder="What's happening?"></textarea>
          </div>

          <div feed shadow elevation="1">

            <% tweets.forEach( function( tweet ) { %>

            <div id="<%= tweet._id %>" tweet layout-vertical>

              <div header layout-horizontal>
                <span author-name><strong><%= tweet.user.name %></strong></span>
                <a author-handle href="/<%= tweet.user.username %>">@<%= tweet.user.username %></a>
                <span time><%= tweet.timestamps.created %></span>
                <span flex></span>
                <span remove-tweet>X</span>
              </div>

              <div text><%= tweet.text %></div>

            </div>

            <% } ); %>

          </div>

        </div>
      </div>
    </div>

    <script src="./autoresize-textarea.js"></script>
    <script src="./fritter.js"></script>

    <script>

      (function () {

        var fritter = Fritter();

        var textarea = AutoresizeTextarea( document.querySelector( 'textarea[tweet-input]' ) );
        textarea.addSubmitListener( function ( text ) {
          fritter.tweet.add( { text: text }, function ( err, tweet ) {
            if ( err ) {
              console.error( err );
              alert( err );
            } else {
              textarea.clear();
              addTweet( tweet );
            }
          } );
        } );

        document.querySelector( '[home]' ).addEventListener( 'click', function ( e ) {
          window.location.replace( '/' );
        } );

        document.querySelector( '#search' ).addEventListener( 'keydown', function ( e ) {
          if ( e.keyCode === 13 ) {
            window.location.replace( '/' + e.target.value );
          }
        } );

        document.querySelector( '[logout]' ).addEventListener( 'click', function ( e ) {
          window.location.replace( '/logout' );
        } );

        document.querySelector( '[feed]' ).addEventListener( 'click', function ( e ) {
          if ( e.target.hasAttribute( 'remove-tweet' ) ) {
            e.preventDefault();
            fritter.tweet.remove(
              {
                _id: e.target.parentElement.parentElement.id
              },
              function ( err, tweet ) {
                if ( err ) {
                  console.error( err );
                  alert( err );
                } else {
                  removeTweet( tweet );
                }
              }
            );
          }
        } );

        var addTweet = function ( tweet ) {

          var html = '';

          html += '<div id="' + tweet._id + '" tweet layout-vertical>';
          html += '<div header layout-horizontal>';
          html += '<span author-name><strong>' + tweet.user.name + '</strong></span>';
          html += '<a author-handle href="/' + tweet.user.username + '">@' + tweet.user.username + '</a>';
          html += '<span time>' + tweet.timestamps.created + '</span>';
          html += '<span flex></span>';
          html += '<span remove-tweet>X</span>';
          html += '</div>';
          html += '<div text>' + tweet.text + '</div>';
          html += '</div>';

          document.querySelector( '[feed]' ).insertAdjacentHTML( 'afterbegin', html );

        };

        var removeTweet = function ( tweet ) {
          var e = document.getElementById( tweet._id );
          if ( e ) {
            e.parentElement.removeChild( e );
          }
        }

      })();

    </script>

  </body>

</html>
